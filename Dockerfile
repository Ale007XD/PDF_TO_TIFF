# Dockerfile

# Этап 1: Используем официальный образ Python 3.9 в slim-версии
# slim-образы содержат минимальный набор пакетов, необходимый для запуска Python,
# что делает конечный образ меньше по размеру.
FROM python:3.9-slim

# Устанавливаем рабочую директорию внутри контейнера.
# Все последующие команды (COPY, RUN, CMD) будут выполняться из этого каталога.
WORKDIR /app

# Устанавливаем системные зависимости в одном слое для оптимизации.
# - apt-get update: обновляет списки пакетов.
# - apt-get install -y --no-install-recommends: устанавливает пакеты без лишних рекомендаций.
#   - ghostscript: основная утилита для конвертации PDF в TIFF.
#   - qpdf: наша новая утилита для проверки и "лечения" поврежденных PDF.
# - && rm -rf /var/lib/apt/lists/*: очищает кэш apt после установки,
#   чтобы уменьшить размер финального образа.
RUN apt-get update && apt-get install -y --no-install-recommends \
    ghostscript \
    qpdf \
    && rm -rf /var/lib/apt/lists/*

# Копируем файл с Python-зависимостями в рабочую директорию.
# Это делается до копирования основного кода, чтобы использовать кэш Docker.
# Если requirements.txt не меняется, Docker не будет переустанавливать зависимости при каждой сборке.
COPY requirements.txt .

# Устанавливаем Python-зависимости.
# --no-cache-dir: отключает кэширование pip, что также помогает уменьшить размер образа.
RUN pip install --no-cache-dir -r requirements.txt

# Копируем все остальные файлы проекта (main.py, pdf_to_tiff.py и т.д.)
# из текущей директории в рабочую директорию контейнера (/app).
COPY . .

# Указываем команду по умолчанию для запуска контейнера.
# Здесь мы запускаем основной файл вашего бота. Убедитесь, что он называется "main.py".
# Если ваш главный файл называется "bot.py", измените команду на ["python", "bot.py"].
CMD ["python", "main.py"]

