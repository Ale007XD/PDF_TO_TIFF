name: "CI/CD: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∏–ª–¥ –∏ –¥–µ–ø–ª–æ–π –Ω–∞ VPS"

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  APP_NAME: pdf-to-tiff-bot

jobs:
  deploy:
    name: "–°–±–æ—Ä–∫–∞ –∏ –¥–µ–ø–ª–æ–π –Ω–∞ VPS"
    runs-on: ubuntu-latest
    steps:
      - name: "SSH-–¥–µ–ø–ª–æ–π –Ω–∞ VPS"
        uses: appleboy/ssh-action@v1.0.3
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            export BOT_TOKEN="${BOT_TOKEN}"

            APP_DIR="$HOME/apps/${{ env.APP_NAME }}"
            REPO_URL="https://github.com/${{ github.repository }}"

            echo "‚è¨ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ —Å GitHub..."
            mkdir -p "$APP_DIR"
            if [ ! -d "$APP_DIR/.git" ]; then
              git clone "$REPO_URL" "$APP_DIR"
            else
              cd "$APP_DIR"
              git fetch origin
              git reset --hard origin/main
            fi

            cd "$APP_DIR"

            if ! command -v docker >/dev/null 2>&1; then
              echo "‚ùå Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
              exit 1
            fi
            if ! docker compose version >/dev/null 2>&1; then
              echo "‚ùå 'docker compose' –Ω–µ –Ω–∞–π–¥–µ–Ω!"
              exit 1
            fi

            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
            docker compose down --remove-orphans || true
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —ç—Ç–∏–º –∏–º–µ–Ω–µ–º, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è –≤ "Exited" –ª–∏–±–æ "Conflict"
            docker rm -f pdf_to_tiff_bot || true

            echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
            docker image prune -f || true

            echo "üî® –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞ –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ VPS..."
            docker compose build --no-cache

            echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
            docker compose up -d --remove-orphans

            echo "üìã –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose ps

            echo "üìÑ –õ–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫):"
            docker compose logs --tail=20

            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
